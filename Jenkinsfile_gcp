node {
    stage("Checkout"){
        checkout([$class: 'GitSCM',
                  branches: [[name: '*/jenkins_gcp']],
                  userRemoteConfigs: [[credentialsId: 'git',
                  url: 'https://github.com/IslamHamada/petshop_deployment.git']]])
    }
    stage("Deploy Pods"){
        step([$class: 'KubernetesEngineBuilder',
            projectId: env.PROJECT_ID,
            clusterName: env.CLUSTER,
            location: env.ZONE,
            manifestPattern: 'k8s/config-maps.yaml',
            credentialsId: env.PROJECT_ID,
            verifyDeployments: true])

        step([$class: 'KubernetesEngineBuilder',
              projectId: env.PROJECT_ID,
              clusterName: env.CLUSTER,
              location: env.ZONE,
              manifestPattern: 'k8s/mysql-deployment.yaml',
              credentialsId: env.PROJECT_ID,
              verifyDeployments: true])

        step([$class: 'KubernetesEngineBuilder',
              projectId: env.PROJECT_ID,
              clusterName: env.CLUSTER,
              location: env.ZONE,
              manifestPattern: 'k8s/zipkin-deployment.yaml',
              credentialsId: env.PROJECT_ID,
              verifyDeployments: true])
    }

    stage("Deploy kube-startup-cpu-boost"){
        sh """
            export USE_GKE_GCLOUD_AUTH_PLUGIN=True
            gcloud container clusters get-credentials ${env.CLUSTER} --region ${env.ZONE} --project ${env.PROJECT_ID}
            # Use --validate=false to bypass the openapi check that's crashing
            kubectl apply -k k8s/ --validate=false 
        """

        step([$class: 'KubernetesEngineBuilder',
              projectId: env.PROJECT_ID,
              clusterName: env.CLUSTER,
              location: env.ZONE,
              manifestPattern: 'k8s/startup-boost.yaml',
              credentialsId: env.PROJECT_ID,
              verifyDeployments: true])
    }
}