node {
    stage("Checkout"){
        checkout([$class: 'GitSCM',
                  branches: [[name: '*/jenkins_gcp']],
                  userRemoteConfigs: [[credentialsId: 'git',
                  url: 'https://github.com/IslamHamada/petshop_deployment.git']]])
    }
    stage("Deploy Pods"){
        step([$class: 'KubernetesEngineBuilder',
            projectId: env.PROJECT_ID,
            clusterName: env.CLUSTER,
            location: env.ZONE,
            manifestPattern: 'k8s/config-maps.yaml',
            credentialsId: env.PROJECT_ID,
            verifyDeployments: true])

        step([$class: 'KubernetesEngineBuilder',
              projectId: env.PROJECT_ID,
              clusterName: env.CLUSTER,
              location: env.ZONE,
              manifestPattern: 'k8s/mysql-deployment.yaml',
              credentialsId: env.PROJECT_ID,
              verifyDeployments: true])

        step([$class: 'KubernetesEngineBuilder',
              projectId: env.PROJECT_ID,
              clusterName: env.CLUSTER,
              location: env.ZONE,
              manifestPattern: 'k8s/zipkin-deployment.yaml',
              credentialsId: env.PROJECT_ID,
              verifyDeployments: true])
    }

    stage("Deploy kube-startup-cpu-boost"){
        step([$class: 'KubernetesEngineBuilder',
              projectId: env.PROJECT_ID,
              clusterName: env.CLUSTER,
              location: env.ZONE,
              manifestPattern: 'k8s/kustomization.yaml',
              credentialsId: env.PROJECT_ID,
              verifyDeployments: false]) // Set to false, as CRDs don't "deploy" like pods

        step([$class: 'KubernetesEngineBuilder',
              projectId: env.PROJECT_ID,
              clusterName: env.CLUSTER,
              location: env.ZONE,
              manifestPattern: 'k8s/startup-boost.yaml',
              credentialsId: env.PROJECT_ID,
              verifyDeployments: true])
    }
}